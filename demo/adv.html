<!DOCTYPE>
<html>
 <head>
  <title>Modelist数据结构DEMO示例-advanced</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="themes/prism.css" data-noprefix>
  <style>
      * {font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace,
      Helvetica, arial, sans-serif;}
      .wrapper {
        width: 90%;
        margin: auto;
      }
      h2 {
        background: #03a9f459;
        padding: 15px;
        border-radius: 5px;
      }
      ul {
        border: 1px outset #ccc;
        border-radius: 5px;
        background-color: #c3cacf14;
        padding:0 20px;
      }
      ul li {
        margin: 20px;
      }
      </style>
 </head>

<body style="width:98%">
  <h2>复杂结构实例，请在控制台看输出结果，或者源码进行断点调试。
    <a href="./basic.html">简单结构DEMO</a>&nbsp;&nbsp;
    <a href="../doc/intro.html">Modelist使用说明</a>
  </h2>
  <ul id="codePanel"></ul>
<!--
   // 使用webpack按umd模式打包后模块(含List与Model)，通过amd或cmd调用
 -->
<!-- <script src="../dist/modelist.min.js"></script> -->

<!-- // 或直接使用es6模块导入esm或源码包 -->
<script type="module" id="sourceCode">
  // import Model from '../src/model.js'
  // import List from '../src/list.js'
  import {Model, List} from '../dist/modelist.esm.js'

    /**example List与匿名Model实例 */
    // 原始数据
    const channelData = [{"id":1,"isBuildAlbum":1,"useType":"1,2,3,4","name":"电影","_index":"category","taiwanName":"電影","code":"dy","isPaidContent":1},{"id":2,"isBuildAlbum":1,"useType":"1,2,3,4","name":"电视剧","_index":"category","taiwanName":"連續劇","code":"dsj","isPaidContent":1},{"id":3,"isBuildAlbum":1,"useType":"1,2,3,4","name":"纪录片","_index":"category","taiwanName":"紀錄片","code":"jlp","isPaidContent":1},{"id":4,"isBuildAlbum":1,"useType":"1,2,3,4","name":"动漫","_index":"category","taiwanName":"動漫","code":"dm","isPaidContent":1},{"id":6,"isBuildAlbum":1,"useType":"1,2,3,4","name":"综艺","_index":"category","taiwanName":"綜藝","code":"zy","isPaidContent":1},{"id":7,"isBuildAlbum":1,"useType":"1,2,3,4","name":"娱乐","_index":"category","taiwanName":"娛樂","code":"yl","isPaidContent":1},{"id":8,"isBuildAlbum":1,"useType":"1,2,3","name":"游戏","_index":"category","taiwanName":"遊戲","code":"yx","isPaidContent":1},{"id":9,"isBuildAlbum":1,"useType":"1,2,3,4","name":"旅游","_index":"category","taiwanName":"旅遊","code":"ly","isPaidContent":0},{"id":10,"isBuildAlbum":0,"useType":"1,2,3,4"},{"id":11,"isBuildAlbum":1,"useType":"","name":"公开课","_index":"category","taiwanName":"公開課","code":"gkk","isPaidContent":0},{"id":12,"isBuildAlbum":1,"useType":"1,2,3","name":"教育","_index":"category","taiwanName":"教育","code":"jy","isPaidContent":1},{"id":13,"isBuildAlbum":1,"useType":"1,2,3","name":"时尚","_index":"category","taiwanName":"時尚","code":"ss","isPaidContent":1},{"id":14,"isBuildAlbum":1,"useType":"","name":"时尚综艺","_index":"category","taiwanName":"時尚綜藝","code":"sszy","isPaidContent":0},{"id":15,"isBuildAlbum":1,"useType":"1,2,3,4","name":"儿童","_index":"category","taiwanName":"兒童","code":"se","isPaidContent":1},{"id":16,"isBuildAlbum":1,"useType":"1,2,3","name":"网络电影","_index":"category","taiwanName":"微電影","code":"wdy","isPaidContent":1},{"id":17,"isBuildAlbum":1,"useType":"1,2,3,4","name":"体育","_index":"category","taiwanName":"體育","code":"ty","isPaidContent":1},{"id":18,"isBuildAlbum":0,"useType":"","name":"奥运","_index":"category","taiwanName":"奧運","code":"ay","isPaidContent":0},{"id":20,"isBuildAlbum":0,"useType":"1,2,3","name":"广告","_index":"category","taiwanName":"廣告","code":"gg","isPaidContent":0},{"id":21,"isBuildAlbum":1,"useType":"1,2,3","name":"生活","_index":"category","taiwanName":"生活","code":"sh","isPaidContent":1},{"id":22,"isBuildAlbum":1,"useType":"1,2,3,4","name":"搞笑","_index":"category","taiwanName":"搞笑","code":"gx","isPaidContent":1},{"id":23,"isBuildAlbum":0,"useType":"","name":"UGC","_index":"category","taiwanName":"UGC","code":"ugc","isPaidContent":0},{"id":24,"isBuildAlbum":1,"useType":"1,2,3","name":"财经","_index":"category","taiwanName":"財經","code":"cj","isPaidContent":1},{"id":25,"isBuildAlbum":1,"useType":"1,2,3","name":"资讯","_index":"category","taiwanName":"時事","code":"zx","isPaidContent":0},{"id":26,"isBuildAlbum":1,"useType":"1,2,3","name":"汽车","_index":"category","taiwanName":"汽車","code":"qc","isPaidContent":1},{"id":27,"isBuildAlbum":1,"useType":"1,2,3,4","name":"原创","_index":"category","taiwanName":"原創","code":"yc","isPaidContent":1},{"id":28,"isBuildAlbum":1,"useType":"1,2,3","name":"军事","_index":"category","taiwanName":"軍事","code":"js","isPaidContent":0},{"id":29,"isBuildAlbum":1,"useType":"1,2,3","name":"母婴","_index":"category","taiwanName":"婦幼","code":"my","isPaidContent":1},{"id":30,"isBuildAlbum":1,"useType":"1,2,3","name":"科技","_index":"category","taiwanName":"科技","code":"kj","isPaidContent":1},{"id":31,"isBuildAlbum":1,"useType":"1,2,3","name":"脱口秀","_index":"category","taiwanName":"脫口秀","code":"tkx","isPaidContent":1},{"id":88,"isBuildAlbum":0,"useType":"","name":"内部培训","_index":"category","taiwanName":"內部培訓","code":"px","isPaidContent":0},{"id":89,"isBuildAlbum":0,"useType":"","name":"PPS","_index":"category","taiwanName":"PPS","code":"pps","isPaidContent":0},{"id":91,"isBuildAlbum":0,"useType":"","name":"淘米","_index":"category","taiwanName":"淘米","code":"tm","isPaidContent":0},{"id":92,"isBuildAlbum":1,"useType":"","name":"联想合作","_index":"category","taiwanName":"聯想合作","code":"lxhz","isPaidContent":0},{"id":96,"isBuildAlbum":0,"useType":"","name":"编码器测试","_index":"category","taiwanName":"編碼器測試","code":"bmcs","isPaidContent":1},{"id":97,"isBuildAlbum":0,"useType":"","name":"其他","_index":"category","taiwanName":"其他","code":"qt","isPaidContent":0},{"id":99,"isBuildAlbum":1,"useType":"","name":"测试频道 ","_index":"category","taiwanName":"測試頻道","code":"cs","isPaidContent":0},{"id":100,"isBuildAlbum":0,"useType":"","name":"广告素材生产频道","_index":"category","taiwanName":"廣告素材生產頻道","code":"ppc_openapi_advertise","isPaidContent":0},{"id":32,"isBuildAlbum":1,"useType":"1,2,3","name":"健康","_index":"category","taiwanName":"健康","code":"jk","isPaidContent":1},{"id":33,"isBuildAlbum":1,"useType":"1,3","name":"公益","_index":"category","taiwanName":"公益","code":"gy","isPaidContent":1},{"id":93,"isBuildAlbum":0,"useType":"","name":"直播标签","_index":"category","taiwanName":"直播标签","code":"lb","isPaidContent":1},{"id":5,"isBuildAlbum":1,"useType":"1,2,3","name":"音乐","_index":"category","taiwanName":"音樂","code":"yy","isPaidContent":1}]
    // 将原始数据添加到List中，因为没有指定ModelClass，数据将编程匿名Model
    let channelList = new List(channelData)
    window.channelList = channelList
    console.log('channelList:', channelList)
    // 根据是否主频道分组，不用统计无效频道
    let result = channelList.groupBy('useType', (m, i) => {
      if (m.id <= 50) {
        return true
      }
    })
    console.log('channelList.groupBy->result:', result)
    // 先删除无效频道
    console.log('channelList.removeBy:', channelList.removeBy((m, i) => {
      return m.id > 50
    }))
    // 再根据频道排序
    console.log('channelList.sortBy:', channelList.sortBy('id'))
    // 获取某个频道对象
    console.log('channelList.getByKeyValue:', channelList.getByKeyValue('id', 3))
    // 得到频道id,name的字符串
    console.log('channelList.map:', channelList.map((m, id) => {
      return m.id + ',' + m.name + '\r\n'
    }).join(''))
    // 输出数组
    console.log('channelList.map:', channelList.map((m, id) => {
      let tmp = {}
      tmp[id] = m.name
      return tmp
    }))
    // 格式化数据
    console.log('channelList.format:', channelList.format({
      useType: (source, model, formatter) => {
        if (typeof source['useType'] === undefined) return ''
        return source['useType'].split(',').map((item, i) => {
          return ['AA', 'BB', 'CC', 'DD'][Number(item) - 1]
        })
      }
    }))
    // 调用原生Array方法根据条件滤出数据
    console.log('channelList.filter:', channelList.filter((model, idx) => {
      return (model.isPaidContent !== 0)
    }))
    // 调用自定义inverse方法反选数据
    console.log('channelList.inverse:', channelList.inverse((model, idx) => {
      return (model.isPaidContent !== 0)
    }).sortBy('id'))
    // 根据条件排序
    console.log('channelList.sortBy:', channelList.sortBy('id', 'desc'))

    /**example 业务Model实例 */
    window.albumData = {
        "orderType": 1,
        "season": 0,
        "id": 108961089,
        "defImg": "http://google.com/image/logo.jpg",
        "contentType": 1,
        "phase": 0,
        "awardEntities": "{\"awardAll\":[{\"id\":114,\"name\":\"MTV电影奖\"},{\"id\":119,\"name\":\"亚洲电影大奖\"},{\"id\":120,\"name\":\"人民选择奖\"},{\"id\":121,\"name\":\"北京国际电影节\"},{\"id\":122,\"name\":\"华语电影传媒大奖\"},{\"id\":124,\"name\":\"土星奖\"},{\"id\":125,\"name\":\"圣丹斯国际电影节\"},{\"id\":126,\"name\":\"多伦多国际电影节\"},{\"id\":127,\"name\":\"大众电影百花奖\"},{\"id\":128,\"name\":\"奥斯卡金像奖\"},{\"id\":129,\"name\":\"威尼斯国际电影节\"},{\"id\":130,\"name\":\"安妮奖\"},{\"id\":132,\"name\":\"意大利电影大卫奖\"},{\"id\":133,\"name\":\"戛纳国际电影节\"},{\"id\":134,\"name\":\"日本电影学院奖\"},{\"id\":135,\"name\":\"柏林国际电影节\"},{\"id\":136,\"name\":\"欧洲电影奖\"},{\"id\":138,\"name\":\"洛迦诺国际电影节\"},{\"id\":139,\"name\":\"美国金球奖\"},{\"id\":140,\"name\":\"艾美奖\"},{\"id\":141,\"name\":\"英国电影和电视艺术学院奖\"},{\"id\":142,\"name\":\"西班牙戈雅奖\"},{\"id\":143,\"name\":\"釜山国际电影节\"},{\"id\":144,\"name\":\"青少年选择奖\"},{\"id\":145,\"name\":\"韩国电影大钟奖\"},{\"id\":146,\"name\":\"韩国电影青龙奖\"},{\"id\":153,\"name\":\"法国凯撒奖\"},{\"id\":154,\"name\":\"中国电影金鸡奖\"},{\"id\":155,\"name\":\"台湾电影金马奖\"},{\"id\":156,\"name\":\"德国电影奖\"},{\"id\":157,\"name\":\"韩国百想艺术大赏\"},{\"id\":158,\"name\":\"香港电影金像奖\"},{\"id\":159,\"name\":\"圣塞巴斯蒂安国际电影节\"},{\"id\":160,\"name\":\"长春国际电影节\"},{\"id\":161,\"name\":\"印度国际电影节\"},{\"id\":162,\"name\":\"开罗国际电影节\"},{\"id\":163,\"name\":\"蒙特利尔国际电影节\"}],\"awards\":[]}",
        "entityType": 1,
        "updateTime": "2018-02-04 08:09:18",
        "entityId": 100126218,
        "titles": [{
            "createTime": "2018-02-03 09:19:50",
            "metaId": 123,
            "language": "zh",
            "id": 545,
            "version": 1
        }, {
            "createTime": "2018-02-03 09:19:50",
            "metaId": 1234,
            "updateTime": "2018-02-03 09:19:50",
            "id": 112184467,
            "version": 0
        }],
        "version": 3,
        "catalogStatus": 1,
        "totalNumberOfEpisodes": 0,
        "site": "SITE_ZH",
        "isOuterUser": false,
        "safeStatus": 0,
        "peopleRoleEntities": "[]",
        "createTime": "2018-02-03 09:19:50",
        "globalPublishDate": "20180203",
        "partnerId": "9969",
        "catalogUser": 1446840285,
        "businessType": 0,
        "auditPublishType": 1,
      "categoryId": 8,
      "first": {
        "second": {
          "third": '层级value'
        }
      }
    }

    class Album extends Model {
      constructor(source, formatter) {
        super()
        // 定义模型属性
        this.define({
          random: 0,
          channel: undefined,
          title: '',
          orderType: 0,
          catalogUser: undefined,
          awardEntities: undefined
        })

        // 定义格式化器，这个格式器也可以定义在Model里
        // 也可以全部由外部传入，或者是内部与外部的组合
        formatter = Object.assign({
          random: Math.round(Math.random() * 1000),
          orderType: (source) => {
            return source.orderType
          },
          catalogStatus: (source) => {
            return source.catalogStatus
          },
          channel: (source, model, formatter) => {
            return source.categoryId
          },
          catalogUser: (source, model, formatter) => {
            return '作者名' + source.catalogUser
          },
          title: (source, model, formatter) => {
            let titles = new List(source.titles)
            titles.removeBy((model, idx) => {
              return model.language != 'zh'
            })
            titles.forEach((model, idx) => {
              model.removeKey('metaId', 'version', 'updateTime')
            })
            return titles
          },
          awardEntities: (source, model, formatter) => {
            if (typeof source['awardEntities'] == 'string') {
              let awardJSON = JSON.parse(source['awardEntities'])
              let awardAll = new List(awardJSON.awardAll)
              return awardAll.groupBy('id')
            } else {
                console.warn('is not string:', source)
            }
          },
          // 层级快选示例
          childValue: ['first', 'second', 'third'],
          // 如果是数组则可以传递数字
          updateTime: ['titles', 1, 'updateTime'],
          first: ['first', 'second', 'third']
        }, formatter)

        // 初始化Model，需要传入source与formatter
        // source是源数据，formatter格式器将源数据的值加工处理再赋值给Model的属性
        this.init(source, formatter)
      }

      // 若覆盖了preprocess方法，即对源数据进行了干预，意思是在format之前把源数据调整为适合format的状态
      // 在preprocess里修改了source之后，Model里面的getSource()会受到影响，也就是最初的源变化了
      // 如果返回是非false，则在之后自动执行format，如果false表示源数据处理后暂停，不自动format数据
      preprocess(source, formatter) {
        source.orderType = 111
        return this
      }
    }
    window.albumModel = new Album(albumData)
    console.log('albumModel:', albumModel, albumModel.toJSON())

    /* 业务Model与List */
    // 如果Album是多份数据，则可以借用List来完成集合操作
    let sourceData = []
    for(var i = 0; i < 5; i++) {
        sourceData.push(albumData)
    }
    // 实例化List，会将数据按照Album的模型来实例化，并执行formatter处理数据
    console.log('sourceData:', sourceData)
    window.albumList = new List(sourceData, Album)
    console.log('albumList:', albumList)
    console.log('albumList.sortBy:', albumList.sortBy('random', 'desc'))
</script>
<script>
(function(doc) {
    const codePanel = doc.querySelector('#codePanel')
    const sourceCodeEle = doc.querySelector('#sourceCode')
    const sourceCodeList = sourceCodeEle.innerText.split('/**example')
    let html = ''
    sourceCodeList.forEach((code, idx) => {
        if (idx < 1) {
            return
        }
        let endPos = code.indexOf('*/')
        let title = code.substr(0, endPos)
        code = code.substr(endPos + 2)
        let tpl = `
          <li>${title}</li>
          <pre>
          <code class="language-js">${code}</code>
          </pre>
          <br>
        `
        html += tpl.trim()
    })
    codePanel.innerHTML = html
})(document)
</script>
<script type="text/javascript" src="themes/prism.js"></script>
 </body>
</html>
